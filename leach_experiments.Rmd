---
title: "Leaching experiments"
author: "Dave Costello"
date: "6/4/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(AER) #For function tobit
library(lmtest) #For function lrtest
library(MASS)

setwd("/Users/dcostel3/Desktop/Bioretention/2018 analysis")
```

###References for Tobit/censored regression
Tobit/censored regression
http://seananderson.ca/2014/05/18/gamma-hurdle.html
http://www.ats.ucla.edu/stat/r/dae/tobit.htm
https://cran.r-project.org/web/packages/censReg/vignettes/censReg.pdf
http://stats.stackexchange.com/questions/149091/censored-regression-in-r (p of <DL)


## Import data
```{r}
#Non-salty tests
leach <- read.csv(file="leach.csv")

#Outliers
leach$Cu_conc[leach$Cu_conc>200] <- NA

leach$Curemove <- with(leach,(Cu_in-Cu_conc)/Cu_in) #Calculate % removal 
leach$Curemove[leach$Curemove<0] <-0 #Set all negative "removals" (i.e., soils added Cu) to zero

#Cell characteristics (from survey analysis)
soilchem <- read.csv(file="soil_metal_NEW.csv")

#Outliers
soilchem[soilchem$Sample=="30a",'Zn'] <- NA
soilchem[soilchem$Sample=="12a",'Cu'] <- NA

cell <- read.csv(file="cell_data_NEW.csv")
cell$Location_name <- as.character(cell$Location_name)

#Calculate log variables
soilchem$logOM <- log10(soilchem$OM)
soilchem$logBD <- log10(soilchem$BD)
soilchem$logd50 <- log10(soilchem$d50)
cell$logDrain <- log10(cell$Drain_area)
#Convert the cell with no drain area to the mean of all others
cell$logDrain[which(is.infinite(cell$logDrain))] <- mean(cell$logDrain[is.finite(cell$logDrain)])
cell$logCell <- log10(cell$Cell_area)
cell$logDtoC <- cell$logDrain/cell$logCell

chemmean <- aggregate(soilchem[,c('OM','BD','d50','logOM','logBD','logd50')],
                      by=list(soilchem$Cell_no),median,na.rm=T)
cellmeans <- merge(cell,chemmean,by.x="Cell_no",by.y="Group.1")

newleach <- merge(leach,cellmeans[,c(1,8:10,13:16,20:22)],by="Cell_no",all.x=T,all.y=F)

#Subsets of the different metal treatments
leachH <- subset(newleach,newleach$Metal=="High")
#leachL <- subset(leach,leach$Metal=="Low")
#leachN <- subset(leach,leach$Metal=="No")


#Salty water
saltleach <- read.csv(file="saltleach.csv")
saltleach$Cell_no <- factor(saltleach$Cell_no) 
summary(leach)

```

*Thresholds for tobit*
Cu minimum DL = 4 µg/L
High Cu stormwater (200 µg/L) removal min=0 and max=0.95
Low Cu stormwater (20 µg/L) removal min=0 and max=0.8


##Leaching statistics (censored regression)
###Cu leaching
```{r}
#High metal stormwater
plot(Curemove~Cell_no,data=leachH)

#Test for location
CuH0 <- tobit(Curemove~frailty(Cell_no),data=leachH,left=0,right=0.95)
CuHl <- tobit(Curemove~Location+frailty.gaussian(Cell_no),data=leachH,left=0,right=0.95)
lrtest(CuH0,CuHl)
  #Location of core doesn't matter so treat all the same

#Test for variables that may affect removal rates
###ADD IN BACKGROUND METAL CONC###
CuHnull <- tobit(Curemove~frailty(Cell_no),data=leachH,left=0,right=0.95)
CuHfull <- tobit(Curemove~Age+Kfs+Retrofit+logDrain+logCell+logDtoC+logOM+logBD+logd50+frailty(Cell_no),data=leachH,left=0,right=0.95)

add1(CuHnull,scope=CuHfull,test="Chisq")
CuH2 <- tobit(Curemove~Retrofit+frailty(Cell_no),data=leachH,left=0,right=0.95)
lrtest(CuH0,CuH2)
add1(CuH2,scope=CuHfull,test="Chisq")

plot(Curemove~Retrofit,data=leachH)
CuH2 <- update(CuH0,~.+Retrofit)
summary(CuH2)

###Why can't I also fit a random effect of cell number?
###USE LOGIT TRANSFORMATION RATHER THAN TOBIT MODELS
###INCLUDE BACKGROUND METAL CONCENTRATIONS IN MODELS BEFORE PROCEEDING

nullmod <- lme(logit(Curemove)~1,random=~1|Cell_no,data=leachH,method="ML",na.action=na.omit)
fullmod <- lme(logit(Curemove)~Age+Kfs+Retrofit+logDrain+logCell+logDtoC+logOM+logBD+logd50,random=~1|Cell_no,data=leachH,method="ML",na.action=na.omit)
add1(nullmod,scope=fullmod,test="Chisq")
mod <- lme(logit(Curemove)~Retrofit,random=~1|Cell_no,data=leachH,method="ML",na.action=na.omit)
anova(nullmod,mod)
add1(mod,scope=fullmod,test="Chisq")
summary(mod)
```

