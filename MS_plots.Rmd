---
title: "Biorentention plots"
author: "Dave Costello"
date: "5/10/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

logaxis = function(minlog,maxlog,side){
  pow <- seq(minlog,maxlog,by=1)
  ticksat <- as.vector(sapply(pow, function(p) (1:10)*10^p))
  axis(side, 10^pow,las=1)
  axis(side, ticksat, labels=NA, tcl=-0.25, lwd=0, lwd.ticks=1)
}

library(lme4)
```



#Data import
```{r}
soilchem <- read.csv(file="soil_metal_NEW.csv")
soilchem$Cell_no <- factor(soilchem$Cell_no)
summary(soilchem)

#Outliers
soilchem[soilchem$Sample=="30a",'Zn'] <- NA
soilchem[soilchem$Sample=="12a",'Cu'] <- NA

cell <- read.csv(file="cell_data_NEW.csv")
cell$Location_name <- as.character(cell$Location_name)
summary(cell)

#Merge both datasets
fullsoil <- merge(soilchem,cell[,c(2:10)],by="Cell_no")
summary(fullsoil)

```


###Bioretention cell size
```{r cell v. drain size}
#dev.copy(pdf,'cellsize.pdf')
par(pin=c(2.5,2.5))
plot(Cell_area~Drain_area,data=cell,log="xy",ylim=c(10,10000),xlim=c(100,10000),xaxt="n",yaxt="n",
     xlab=expression("Drainage basin area (m"^2*")"),ylab=expression("Bioretention cell area (m"^2*")"),
     cex=1.3,pch=c(5,19)[Retrofit])
logaxis(2,4,1)
logaxis(1,4,2)

#Practicioner benchmarks
abline(a=log10(1/20),1,lwd=2,lty=3) #Ideal size of cell 5-10% the size of drain area
abline(a=log10(1/10),1,lwd=2,lty=3) 
text(14000,220,"5%",pos=2)
text(14000,1200,"10%",pos=2)

#Our data
cdmod <- lm(log10(Cell_area)~log10(Drain_area),data=cell[cell$Drain_area!=0,])
abline(cdmod,col="red")
text(14000,4000,"29%",pos=2,col="red")


legend("topleft",legend=c("New build","Retrofit"),pch=c(5,19),pt.cex=1.3,cex=0.8)

points(100,345,pch=19,cex=1.3,col="grey75") #Cell with no drainage area

#dev.off()
```

###Soil metals through time
```{r metal through time}
fullsoil$offAge <- ifelse(fullsoil$Depth=="0 to 10",fullsoil$Age+0.1,fullsoil$Age-0.1)
Cumod <- lmer(log10(Cu)~Age*Depth+log10(OM)+(1|Cell_no),data=fullsoil,REML=F)
Pbmod <- lmer(log10(Pb)~Age+Depth+log10(OM)+log10(OM):Age+(1|Cell_no),data=fullsoil,REML=F)
Znmod <- lmer(log10(Zn)~Age+Depth+log10(OM)+(1|Cell_no),data=fullsoil,REML=F)

xAge <- seq(0,7,length=50)
yCudep <- predict(Cumod,newdata=list(Age=xAge,Depth=rep("10 to 20",length(xAge)),
                                     OM=rep(median(fullsoil$OM,na.rm=T),length(xAge))),re.form=~0)
yCush <- predict(Cumod,newdata=list(Age=xAge,Depth=rep("0 to 10",length(xAge)),
                                     OM=rep(median(fullsoil$OM,na.rm=T),length(xAge))),re.form=~0)

yPbH <- predict(Pbmod,newdata=list(Age=xAge,Depth=rep("0 to 10",length(xAge)),
                                   OM=rep(80,length(xAge))),re.form=~0)
yPbL <- predict(Pbmod,newdata=list(Age=xAge,Depth=rep("0 to 10",length(xAge)),
                                   OM=rep(5,length(xAge))),re.form=~0)

yZnS <- predict(Znmod,newdata=list(Age=xAge,Depth=rep("0 to 10",length(xAge)),
                                   OM=rep(median(fullsoil$OM,na.rm=T),length(xAge))),re.form=~0)
yZnD <- predict(Znmod,newdata=list(Age=xAge,Depth=rep("10 to 20",length(xAge)),
                                   OM=rep(median(fullsoil$OM,na.rm=T),length(xAge))),re.form=~0)

  
pdf(file="cellmetal.pdf",height=5,width=3)

par(mfrow=c(3,1),oma=c(3,5,0,1),mar=c(0,0,2,0))
plot(Cu~offAge,data=fullsoil,log="y",yaxt="n",ylim=c(5,1000),xaxt="n",
     col=c("black","red")[Depth],pch=c(1,15)[Depth],cex=1.1)
lines(xAge,10^yCudep,col="red")
lines(xAge,10^yCush,col="black")
logaxis(0,3,2)
axis(1,labels=F)
mtext(expression("Soil Cu (mg kg"^-1*")"),2,line=3,cex=0.8)
mtext("a",2,line=-1,at=800,las=1)
legend("topright",legend=c("Surface (0-10 cm)","Deep (10-20 cm)"),pch=c(1,15),col=c("black","red"),cex=0.8,lty=1)

par(mar=c(1,0,1,0))
plot(Pb~offAge,data=fullsoil,log="y",yaxt="n",ylim=c(5,1000),xaxt="n",
     col=c("black","red")[Depth],pch=c(1,15)[Depth],cex=1.1)
logaxis(1,3,2)
axis(1,labels=F)
mtext(expression("Soil Pb (mg kg"^-1*")"),2,line=3,cex=0.8)
mtext("b",2,line=-1,at=800,las=1)
#lines(xAge,10^yPbL,lty=2)
lines(xAge,10^yPbH,lty=2)
text(5,200,"High OM")
#text(5.5,10,"Low OM")

par(mar=c(2,0,0,0))
plot(Zn~offAge,data=fullsoil,log="y",yaxt="n",ylim=c(10,1000),
     col=c("black","red")[Depth],pch=c(1,15)[Depth],cex=1.1)
logaxis(1,3,2)
mtext(expression("Soil Zn (mg kg"^-1*")"),2,line=3,cex=0.8)
mtext("Age (yr)",1,line=3,cex=0.8)
mtext("c",2,line=-1,at=800,las=1)
lines(xAge,10^yZnD,col="red")
lines(xAge,10^yZnS,col="black")


dev.off()
```

###Cu removal rates
```{r removal rates}

```

